<!doctype html>
<html lang="en">
<head>
  <meta charset="UTF-8"/>
  <meta name="viewport" content="width=device-width, initial-scale=1.0"/>
  <title>Admin</title>
  <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.5.0/css/all.min.css" />
  <style>
    :root { --card-width: 360px; --text-scale: 1; }
    body { font-family: system-ui, -apple-system, Segoe UI, Roboto, sans-serif; margin: 0; background:#0b0b0b; color:#eee; }
    header { position:relative; padding: 12px 16px; border-bottom: 1px solid #333; display:flex; align-items:center; justify-content:space-between;}
    .header-title { position:absolute; left:50%; transform: translateX(-50%); font-weight:700; font-size: clamp(1.3rem, 2.5vw, 2rem); }
    main { padding: 16px; display:grid; grid-template-columns: 1fr 320px; gap: 16px; }
    .list { display: grid; grid-template-columns: repeat(auto-fit, minmax(var(--card-width, 360px), 1fr)); gap: 16px; }
    .card { position:relative; background:#161616; border:1px solid #333; border-radius:12px; padding:16px; display:flex; gap:16px; align-items:center; }
    img { width: 96px; height:96px; object-fit: cover; border-radius: 8px; background:#222; }
    .name { font-weight:700; font-size: calc(1rem * var(--text-scale, 1)); }
    .time { font-size: calc(1.1rem * var(--text-scale, 1)); font-weight:700; }
    .row { display:flex; gap:8px; align-items:center; flex-wrap: wrap; }
    .icon { width:40px; height:40px; padding:0; display:grid; place-items:center; border-radius:8px; }
    .icon i { pointer-events:none; }
    button { background:#2d6cdf; color:white; border:none; padding:8px 12px; border-radius:8px; cursor:pointer; }
    button.secondary { background:#333; color:#ddd; }
    button.danger { background:#b64a4a; }
    .top-actions { position:absolute; top:8px; right:8px; display:flex; gap:8px; }
    label { display:block; font-size:12px; color:#aaa; margin-top:8px; }
    input { width:100%; padding:8px; border-radius:8px; background:#111; color:#eee; border:1px solid #333; }
    form { background:#161616; padding:12px; border:1px solid #333; border-radius:12px; }
    .running { outline: 2px solid #26a269; }
    .card.running .name, .card.running .time { color: #26a269; }
    a { color:#7aa2ff; text-decoration:none; }
    .card.dragging { opacity: 0.5; }
    .header-actions { margin-left:auto; display:flex; align-items:center; gap:8px; }
  </style>
</head>
<body>
<header>
  <div class="header-title" id="headerTitle"></div>
  <div class="header-actions">
    <nav><a href="/">audience view</a></nav>
    <button id="fullscreenBtn" class="icon" title="Toggle fullscreen"><i class="fa-solid fa-expand"></i></button>
  </div>
</header>
<main>
  <section>
    <div class="row" style="margin-bottom:8px; gap:12px;">
      <button id="stopAll">Stop all</button>
      <label style="display:flex; align-items:center; gap:6px; margin:0;">
        <input type="checkbox" id="autoStopToggle"/>
        Auto stop others on start
      </label>
    </div>
    <div class="row" style="margin-bottom:16px; gap:8px; align-items: center;">
      <input id="titleInput" placeholder="Title (optional)" style="max-width:420px;flex:1;"/>
      <button id="saveTitle" class="secondary" title="Save title"><i class="fa-solid fa-floppy-disk"></i></button>
    </div>
    <div class="row" style="margin-bottom:16px; gap:16px; flex-wrap:wrap; align-items:center;">
      <label style="display:flex; align-items:center; gap:8px; margin:0;">
        Admin card width
        <input id="widthRange" type="range" min="280" max="600" step="10" style="width:220px;">
        <span id="widthVal" style="min-width:48px; text-align:right; color:#aaa; font-variant-numeric: tabular-nums;">360px</span>
      </label>
      <label style="display:flex; align-items:center; gap:8px; margin:0;">
        Admin text size
        <input id="textRange" type="range" min="80" max="160" step="5" style="width:220px;">
        <span id="textVal" style="min-width:48px; text-align:right; color:#aaa; font-variant-numeric: tabular-nums;">100%</span>
      </label>
    </div>
    <div class="row" style="margin-bottom:16px; gap:16px; flex-wrap:wrap; align-items:center;">
      <label style="display:flex; align-items:center; gap:8px; margin:0;">
        Main card width
        <input id="widthRangeMain" type="range" min="280" max="600" step="10" style="width:220px;">
        <span id="widthValMain" style="min-width:48px; text-align:right; color:#aaa; font-variant-numeric: tabular-nums;">360px</span>
      </label>
      <label style="display:flex; align-items:center; gap:8px; margin:0;">
        Main text size
        <input id="textRangeMain" type="range" min="80" max="160" step="5" style="width:220px;">
        <span id="textValMain" style="min-width:48px; text-align:right; color:#aaa; font-variant-numeric: tabular-nums;">100%</span>
      </label>
    </div>
    <div id="list" class="list"></div>
  </section>
  <aside>
    <form id="form">
      <h3 style="margin:0 0 8px 0;">Add / Edit Speaker</h3>
      <input type="hidden" id="id" />
      <label>Name</label>
      <input id="name" placeholder="Speaker name"/>
      <label>Face Image</label>
      <input id="imageFile" type="file" accept="image/*"/>
      <div class="row" style="margin-top:12px;">
        <button type="submit">Save</button>
        <button type="button" id="clear" class="secondary">Clear</button>
      </div>
    </form>
  </aside>
</main>
<script>
  const listEl = document.getElementById('list');
  const form = document.getElementById('form');
  const idEl = document.getElementById('id');
  const nameEl = document.getElementById('name');
  const imageInput = document.getElementById('imageFile');
  const stopAllBtn = document.getElementById('stopAll');
  const autoStopToggle = document.getElementById('autoStopToggle');
  const headerTitle = document.getElementById('headerTitle');
  const titleInput = document.getElementById('titleInput');
  const saveTitleBtn = document.getElementById('saveTitle');
  const fullscreenBtn = document.getElementById('fullscreenBtn');
  const widthRange = document.getElementById('widthRange');
  const textRange = document.getElementById('textRange');
  const widthVal = document.getElementById('widthVal');
  const textVal = document.getElementById('textVal');
  const widthRangeMain = document.getElementById('widthRangeMain');
  const textRangeMain = document.getElementById('textRangeMain');
  const widthValMain = document.getElementById('widthValMain');
  const textValMain = document.getElementById('textValMain');

  function msToClock(ms){
    const s = Math.floor(ms/1000);
    const hh = Math.floor(s/3600).toString().padStart(2,'0');
    const mm = Math.floor((s%3600)/60).toString().padStart(2,'0');
    const ss = Math.floor(s%60).toString().padStart(2,'0');
    return `${hh}:${mm}:${ss}`;
  }

  let dragSrcId = null;
  let currentSpeakers = [];
  function render(list){
    currentSpeakers = Array.isArray(list) ? list.slice() : [];
    listEl.innerHTML = '';
    list.forEach(sp => {
      const card = document.createElement('div');
      card.className = 'card' + (sp.running ? ' running' : '');
      card.dataset.id = sp.id;
      card.draggable = true;
      // drag events
      card.addEventListener('dragstart', (e) => { dragSrcId = sp.id; card.classList.add('dragging'); });
      card.addEventListener('dragend', () => { dragSrcId = null; card.classList.remove('dragging'); });
      card.addEventListener('dragover', (e) => { e.preventDefault(); });
      card.addEventListener('drop', async (e) => {
        e.preventDefault();
        const targetId = sp.id;
        if (!dragSrcId || dragSrcId === targetId) return;
        const ids = currentSpeakers.map(s => s.id);
        const from = ids.indexOf(dragSrcId);
        const to = ids.indexOf(targetId);
        if (from === -1 || to === -1) return;
        ids.splice(to, 0, ids.splice(from, 1)[0]);
        try { await fetch('/api/speakers/reorder', { method:'POST', headers:{'Content-Type':'application/json'}, body: JSON.stringify(ids) }); } catch(err) { console.warn('reorder failed', err); }
      });

      // image
      const img = document.createElement('img');
      img.src = `/api/speakers/${sp.id}/image`;
      img.onerror = () => { img.onerror = null; img.src = 'https://dummyimage.com/256x256/222/999&text=+'; };

      // top-right action: delete (x)
      const top = document.createElement('div');
      top.className = 'top-actions';
      const delIcon = document.createElement('button');
      delIcon.className = 'icon danger';
      delIcon.title = 'Delete';
      delIcon.innerHTML = '<i class="fa-solid fa-xmark"></i>';
      delIcon.onclick = async (ev) => {
        ev.stopPropagation();
        if (confirm('Delete speaker?')) { await fetch(`/api/speakers/${sp.id}`, {method:'DELETE'}); }
      };
      top.appendChild(delIcon);

      const meta = document.createElement('div');
      meta.style.flex = '1';
      const nm = document.createElement('div');
      nm.className = 'name';
      nm.textContent = sp.name || '(no name)';
      const tm = document.createElement('div');
      tm.className = 'time';
      tm.textContent = msToClock(sp.elapsedMillis || 0);

      const row = document.createElement('div');
      row.className = 'row';
      const startBtn = document.createElement('button');
      startBtn.className = 'icon';
      startBtn.title = 'Start';
      startBtn.innerHTML = '<i class="fa-solid fa-play"></i>';
      startBtn.onclick = async () => { await fetch(`/api/speakers/${sp.id}/start`, {method:'POST'}); };
      const stopBtn = document.createElement('button');
      stopBtn.className = 'icon secondary';
      stopBtn.title = 'Stop';
      stopBtn.innerHTML = '<i class="fa-solid fa-stop"></i>';
      stopBtn.onclick = async () => { await fetch(`/api/speakers/${sp.id}/stop`, {method:'POST'}); };

      row.appendChild(startBtn);
      row.appendChild(stopBtn);
      meta.appendChild(nm);
      meta.appendChild(tm);
      meta.appendChild(row);
      card.appendChild(img);
      card.appendChild(top);
      card.appendChild(meta);
      listEl.appendChild(card);
    });
  }

  form.onsubmit = async (e) => {
    e.preventDefault();
    const id = idEl.value.trim();
    const name = nameEl.value.trim();
    if (!name) { alert('Name is required'); return; }
    let speakerId = id;
    if (id) {
      await fetch(`/api/speakers/${id}`, {method:'PUT', headers:{'Content-Type':'application/json'}, body: JSON.stringify({name})});
    } else {
      const res = await fetch(`/api/speakers`, {method:'POST', headers:{'Content-Type':'application/json'}, body: JSON.stringify({name})});
      const sp = await res.json();
      speakerId = sp.id;
    }
    // Upload image if selected
    const file = imageInput.files && imageInput.files[0];
    if (file && speakerId) {
      try {
        await fetch(`/api/speakers/${speakerId}/image`, { method:'POST', headers: {'Content-Type': file.type || 'application/octet-stream'}, body: file });
      } catch(err) { console.error(err); }
    }
    idEl.value = '';
    nameEl.value = '';
    try { imageInput.value = ''; } catch(err) {}
  };
  document.getElementById('clear').onclick = () => { idEl.value = ''; nameEl.value = ''; try { imageInput.value = ''; } catch(e) {} };
  stopAllBtn.onclick = async () => { await fetch('/api/speakers/stopAll', {method:'POST'}); };

  // Auto-stop toggle wiring
  async function loadAutoStop(){
    try {
      const res = await fetch('/api/speakers/autoStop');
      const data = await res.json();
      autoStopToggle.checked = !!data.enabled;
    } catch(err) { console.warn('Failed to load autoStop setting', err); }
  }
  autoStopToggle.addEventListener('change', async () => {
    try {
      await fetch('/api/speakers/autoStop', { method:'POST', headers:{'Content-Type':'application/json'}, body: JSON.stringify({enabled: autoStopToggle.checked}) });
    } catch(err) { console.warn('Failed to update autoStop setting', err); }
  });
  loadAutoStop();

  // Title wiring
  async function loadTitle(){
    try {
      const res = await fetch('/api/speakers/title');
      const data = await res.json();
      const t = (data && typeof data.title === 'string') ? data.title : '';
      headerTitle.textContent = t;
      titleInput.value = t;
    } catch(err) { console.warn('Failed to load title', err); }
  }
  loadTitle();
  saveTitleBtn.addEventListener('click', async (e) => {
    e.preventDefault();
    try {
      await fetch('/api/speakers/title', { method:'POST', headers:{'Content-Type':'application/json'}, body: JSON.stringify({title: titleInput.value || ''}) });
    } catch(err) { console.warn('Failed to save title', err); }
  });

  // Size controls wiring
  function applySize(cw, ts){
    if (typeof cw === 'number' && !Number.isNaN(cw)) {
      document.documentElement.style.setProperty('--card-width', cw + 'px');
      if (widthRange) { widthRange.value = String(cw); }
      if (widthVal) { widthVal.textContent = cw + 'px'; }
    }
    if (typeof ts === 'number' && !Number.isNaN(ts)) {
      const scale = Math.max(50, Math.min(200, ts)) / 100;
      document.documentElement.style.setProperty('--text-scale', String(scale));
      if (textRange) { textRange.value = String(ts); }
      if (textVal) { textVal.textContent = ts + '%'; }
    }
  }
  async function loadSize(){
    try {
      const res = await fetch('/api/speakers/size');
      const data = await res.json();
      const cw = Number(data.cardWidth) || 360;
      const ts = Number(data.textScale) || 100;
      applySize(cw, ts);
    } catch(err) { console.warn('Failed to load size', err); }
  }
  let sizePostTimer = null;
  function postSize(){
    const cw = Number(widthRange.value);
    const ts = Number(textRange.value);
    fetch('/api/speakers/size', { method:'POST', headers:{'Content-Type':'application/json'}, body: JSON.stringify({cardWidth: cw, textScale: ts}) })
      .catch(err => console.warn('Failed to update size', err));
  }
  if (widthRange && textRange){
    const schedulePost = () => {
      if (sizePostTimer) clearTimeout(sizePostTimer);
      sizePostTimer = setTimeout(postSize, 150);
    };
    widthRange.addEventListener('input', () => applySize(Number(widthRange.value), undefined));
    textRange.addEventListener('input', () => applySize(undefined, Number(textRange.value)));
    widthRange.addEventListener('change', schedulePost);
    textRange.addEventListener('change', schedulePost);
  }
  loadSize();

  // Main page size controls wiring
  function applySizeMain(cw, ts){
    if (typeof cw === 'number' && !Number.isNaN(cw)) {
      if (widthRangeMain) { widthRangeMain.value = String(cw); }
      if (widthValMain) { widthValMain.textContent = cw + 'px'; }
    }
    if (typeof ts === 'number' && !Number.isNaN(ts)) {
      if (textRangeMain) { textRangeMain.value = String(ts); }
      if (textValMain) { textValMain.textContent = ts + '%'; }
    }
  }
  async function loadSizeMain(){
    try {
      const res = await fetch('/api/speakers/sizeMain');
      const data = await res.json();
      const cw = Number(data.cardWidth) || 360;
      const ts = Number(data.textScale) || 100;
      applySizeMain(cw, ts);
    } catch(err) { console.warn('Failed to load main size', err); }
  }
  let sizePostTimerMain = null;
  function postSizeMain(){
    const cw = Number(widthRangeMain.value);
    const ts = Number(textRangeMain.value);
    fetch('/api/speakers/sizeMain', { method:'POST', headers:{'Content-Type':'application/json'}, body: JSON.stringify({cardWidth: cw, textScale: ts}) })
      .catch(err => console.warn('Failed to update main size', err));
  }
  if (widthRangeMain && textRangeMain){
    const schedulePostMain = () => {
      if (sizePostTimerMain) clearTimeout(sizePostTimerMain);
      sizePostTimerMain = setTimeout(postSizeMain, 150);
    };
    widthRangeMain.addEventListener('input', () => applySizeMain(Number(widthRangeMain.value), undefined));
    textRangeMain.addEventListener('input', () => applySizeMain(undefined, Number(textRangeMain.value)));
    widthRangeMain.addEventListener('change', schedulePostMain);
    textRangeMain.addEventListener('change', schedulePostMain);
  }
  loadSizeMain();

  // Fullscreen toggle
  function isFull(){ return !!(document.fullscreenElement || document.webkitFullscreenElement || document.msFullscreenElement); }
  function enterFull(){
    const el = document.documentElement;
    const req = el.requestFullscreen || el.webkitRequestFullscreen || el.msRequestFullscreen;
    if (req) req.call(el);
  }
  function exitFull(){
    const ex = document.exitFullscreen || document.webkitExitFullscreen || document.msExitFullscreen;
    if (ex) ex.call(document);
  }
  function updateFsIcon(){
    fullscreenBtn.innerHTML = isFull() ? '<i class="fa-solid fa-compress"></i>' : '<i class="fa-solid fa-expand"></i>';
  }
  fullscreenBtn.addEventListener('click', () => {
    if (isFull()) exitFull(); else enterFull();
  });
  document.addEventListener('fullscreenchange', updateFsIcon);
  document.addEventListener('webkitfullscreenchange', updateFsIcon);
  document.addEventListener('msfullscreenchange', updateFsIcon);
  updateFsIcon();

  let ws;
  function connect(){
    ws = new WebSocket((location.protocol === 'https:'?'wss':'ws') + '://' + location.host + '/ws');
    ws.onmessage = (e) => {
      try {
        const data = JSON.parse(e.data);
        if (Array.isArray(data)) {
          render(data);
        } else if (data && data.type === 'autoStop') {
          autoStopToggle.checked = !!data.enabled;
        } else if (data && data.type === 'title') {
          const t = (typeof data.value === 'string') ? data.value : '';
          headerTitle.textContent = t;
          titleInput.value = t;
        } else if (data && data.type === 'size') {
          const cw = Number(data.cardWidth);
          const ts = Number(data.textScale);
          applySize(Number.isFinite(cw) ? cw : undefined, Number.isFinite(ts) ? ts : undefined);
        } else if (data && data.type === 'sizeMain') {
          const cw = Number(data.cardWidth);
          const ts = Number(data.textScale);
          applySizeMain(Number.isFinite(cw) ? cw : undefined, Number.isFinite(ts) ? ts : undefined);
        }
      } catch(err) {
        // ignore malformed messages
      }
    };
    ws.onclose = () => setTimeout(connect, 1000);
  }
  connect();
</script>
</body>
</html>
